<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{admin/admin_template :: admin_template('관리자 - AI 상품 추천', 'AI 상품 추천', ~{::content}, ~{::script})}">

<th:block th:fragment="content">

    <section class="admin-content">

        <style>
            /* =========================================
               페이지 전용 스타일
               ========================================= */
            .board-admin {
                display: flex; flex-direction: column; gap: 30px;
            }

            .board-section {
                background: #fff; padding: 25px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

            /* 1. 상단 통계 카드 영역 */
            .stats-container {
                display: flex; gap: 20px;
                margin-bottom: 10px;
            }

            .stat-card {
                flex: 1;
                background: #fff;
                padding: 20px 25px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-left: 5px solid #22304e;
            }

            .stat-info h4 { margin: 0 0 5px 0; font-size: 0.9rem; color: #666; font-weight: 500; }
            .stat-info p { margin: 0; font-size: 1.8rem; font-weight: 700; color: #22304e; }

            /* 아이콘 스타일 삭제됨 (HTML에서 태그 제거함) */

            /* 2. 테이블 스타일 */
            .board-table-wrapper {
                overflow-x: auto; min-width: 1000px;
            }
            .ai-table {
                width: 100%; table-layout: fixed !important;
                border-collapse: collapse;
            }
            .ai-table th, .ai-table td {
                vertical-align: middle; text-align: center !important;
                padding: 12px 5px; border-bottom: 1px solid #eee;
                font-size: 13px; white-space: nowrap;
                overflow: hidden; text-overflow: ellipsis;
            }
            .ai-table th {
                background-color: #f8f9fa; font-weight: 700; color: #495057;
                border-top: 2px solid #22304e; height: 45px;
            }
            .ai-table td { height: 50px; color: #444; }

            /* 3. 배지 스타일 */
            .tendency-badge {
                padding: 4px 10px; border-radius: 4px; font-size: 11px;
                color: #5e35b1; background-color: #ede7f6;
                border: 1px solid #d1c4e9; font-weight: 600;
            }

            /* 상태 배지 */
            .status-rec { background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; }
            .status-join { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; }
            .status-wait { background-color: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; }

            /* 설문 상태 배지 */
            .survey-active { color: #28a745; font-weight: bold; background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
            .survey-inactive { color: #999; font-weight: bold; background: #f1f1f1; padding: 4px 8px; border-radius: 4px; font-size: 11px; }

            /* 버튼 */
            .btn-push {
                background-color: #22304e; color: #fff; border: 1px solid #22304e;
                padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;
            }
            .btn-push:hover { opacity: 0.9; }

            .btn-detail {
                background-color: #fff; border: 1px solid #ddd; color: #333;
                padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;
            }
            .btn-detail:hover { background-color: #f8f9fa; }

            /* 신규 등록 버튼 */
            .btn-create {
                background-color: #22304e; color: #fff; border: none;
                padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;
                display: flex; align-items: center; gap: 5px;
            }
            .btn-create:hover { opacity: 0.9; }

            /* 헤더 컨트롤 */
            .board-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
            .board-header h2 { margin: 0; font-size: 1.25rem; font-weight: 700; color: #333; }

            .search-form-inline { display: flex; align-items: center; gap: 5px; }
            .search-select-mini { width: 110px; height: 36px; border: 1px solid #ddd; border-radius: 4px; padding: 0 8px; }
            .search-input-mini { width: 200px; height: 36px; border: 1px solid #ddd; border-radius: 4px; padding: 0 10px; }
            .btn-search-mini { height: 36px; padding: 0 15px; background: #22304e; color: #fff; border:none; border-radius: 4px; cursor: pointer; }

            /* 설문 등록 모달 */
            .survey-modal-overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.45);
                display: none; align-items: center; justify-content: center; z-index: 9999;
            }
            .survey-modal-overlay.active { display: flex; }
            .survey-modal {
                width: 920px; max-width: 94%;
                background: #fff; border-radius: 12px;
                box-shadow: 0 12px 30px rgba(0,0,0,0.15);
                overflow: hidden;
            }
            .survey-modal-header {
                background: #B7C9E2; color: #3C4F76;
                padding: 18px 24px; display: flex; align-items: center; justify-content: space-between;
            }
            .survey-modal-header h3 { margin: 0; font-size: 18px; font-weight: 700; }
            .survey-modal-close {
                border: none; background: transparent; font-size: 24px; cursor: pointer; color: #3C4F76;
            }
            .survey-modal-body {
                background: #FAFAFA; padding: 24px; max-height: 70vh; overflow-y: auto;
            }
            .survey-form-section {
                background: #F7F3EE; border-radius: 10px; padding: 16px; margin-bottom: 16px;
            }
            .survey-form-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
            .survey-form-row label { font-size: 12px; color: #3C4F76; font-weight: 600; margin-bottom: 4px; display: block; }
            .survey-input, .survey-select, .survey-textarea {
                width: 100%; border: 1px solid #d9d9d9; border-radius: 6px; padding: 8px 10px; font-size: 13px;
                background: #fff;
            }
            .survey-textarea { min-height: 80px; resize: vertical; }
            .survey-col-6 { flex: 1 1 260px; }
            .survey-col-12 { flex: 1 1 100%; }
            .survey-question-card {
                border: 1px solid #e2e2e2; border-radius: 10px; padding: 14px; background: #fff; margin-bottom: 14px;
            }
            .survey-question-header {
                display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
            }
            .survey-question-title { font-size: 14px; font-weight: 700; color: #3C4F76; }
            .survey-btn {
                background: #3C4F76; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer;
            }
            .survey-btn-light {
                background: #fff; color: #3C4F76; border: 1px solid #3C4F76;
            }
            .survey-option-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
            .survey-option-row .survey-input { flex: 1; }
            .survey-modal-footer {
                padding: 16px 24px; display: flex; justify-content: flex-end; gap: 8px; background: #fff;
                border-top: 1px solid #eee;
            }
            .survey-btn-cancel {
                background: #fff; color: #3C4F76; border: 1px solid #3C4F76; border-radius: 6px; padding: 8px 14px; cursor: pointer;
            }
            .survey-btn-save {
                background: #3C4F76; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer;
            }
        </style>

        <div class="board-admin">

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-info">
                        <h4>오늘의 AI 추천 건수</h4>
                        <p>142 <span style="font-size: 1rem; color: #28a745;">(+12)</span></p>
                    </div>
                </div>
                <div class="stat-card" style="border-left-color: #28a745;">
                    <div class="stat-info">
                        <h4>추천 대비 가입률</h4>
                        <p>34.5% <span style="font-size: 1rem; color: #666;">(전일대비 ▲)</span></p>
                    </div>
                </div>
                <div class="stat-card" style="border-left-color: #17a2b8;">
                    <div class="stat-info">
                        <h4>인기 추천 상품 (1위)</h4>
                        <p style="font-size: 1.2rem; margin-top:5px;">슈카 달러 풀링 예금</p>
                    </div>
                </div>
            </div>

            <section class="board-section">
                <div class="board-header">
                    <h2>AI 기반 상품 추천 이력 관리</h2>
                    <div class="header-controls">
                        <form class="search-form-inline">
                            <select class="search-select-mini">
                                <option>전체</option>
                                <option>가입완료</option>
                                <option>추천완료(미가입)</option>
                            </select>
                            <input type="text" class="search-input-mini" placeholder="고객명 또는 상품명">
                            <button type="submit" class="btn-search-mini">조회</button>
                        </form>
                    </div>
                </div>

                <div class="board-table-wrapper">
                    <table class="ai-table">
                        <colgroup>
                            <col style="width: 5%">  <col style="width: 8%">  <col style="width: 15%"> <col style="width: 32%"> <col style="width: 12%"> <col style="width: 12%"> <col style="width: 16%"> </colgroup>
                        <thead>
                        <tr>
                            <th>No</th>
                            <th>고객명</th>
                            <th>AI 분석 성향</th>
                            <th>추천 외화 상품</th>
                            <th>추천 일자</th>
                            <th>진행 상태</th>
                            <th>관리</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>124</td>
                            <td>김철수</td>
                            <td><span class="tendency-badge">공격적 환테크형</span></td>
                            <td style="font-weight: bold; color: #333;">슈카 달러 풀링 예금</td>
                            <td>2024-12-12</td>
                            <td><span class="status-join">가입완료</span></td>
                            <td><button class="btn-detail">상세내역</button></td>
                        </tr>
                        <tr>
                            <td>123</td>
                            <td>이영희</td>
                            <td><span class="tendency-badge">실속 추구형</span></td>
                            <td>FLOBANK 더 와이드 외화적금</td>
                            <td>2024-12-12</td>
                            <td><span class="status-rec">추천발송</span></td>
                            <td><button class="btn-push"><i class="fa-regular fa-bell"></i> 재알림</button></td>
                        </tr>
                        <tr>
                            <td>122</td>
                            <td>박민수</td>
                            <td><span class="tendency-badge">단기 유동성 중시</span></td>
                            <td>FLOBANK 외화보통예금</td>
                            <td>2024-12-11</td>
                            <td><span class="status-wait">미가입</span></td>
                            <td><button class="btn-push"><i class="fa-regular fa-paper-plane"></i> 프로모션</button></td>
                        </tr>
                        <tr>
                            <td>121</td>
                            <td>정우성</td>
                            <td><span class="tendency-badge">고액 자산 운용</span></td>
                            <td style="font-weight: bold; color: #333;">FLOBANK 외화 고단위 플러스</td>
                            <td>2024-12-10</td>
                            <td><span class="status-join">가입완료</span></td>
                            <td><button class="btn-detail">상세내역</button></td>
                        </tr>
                        <tr>
                            <td>120</td>
                            <td>최지혜</td>
                            <td><span class="tendency-badge">안정 지향형</span></td>
                            <td>FLOBANK 외화정기예금</td>
                            <td>2024-12-09</td>
                            <td><span class="status-rec">추천발송</span></td>
                            <td><button class="btn-push"><i class="fa-regular fa-bell"></i> 재알림</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" style="display: flex; justify-content: center; margin-top: 20px; gap: 5px;">
                    <a href="#" class="page-btn prev" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; color: #333; text-decoration: none;">〈</a>
                    <a href="#" class="page-btn active" style="padding: 5px 10px; border: 1px solid #22304e; background-color: #22304e; color: #fff; border-radius: 4px; text-decoration: none;">1</a>
                    <a href="#" class="page-btn" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; color: #333; text-decoration: none;">2</a>
                    <a href="#" class="page-btn" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; color: #333; text-decoration: none;">〉</a>
                </div>
            </section>

            <section class="board-section">

                <div class="board-header">
                    <h2>AI 설문지 콘텐츠 관리</h2>
                    <div class="header-controls">
                        <button class="btn-create">
                            <i class="fa-solid fa-plus"></i> 신규 설문 등록
                        </button>
                    </div>
                </div>

                <div class="board-table-wrapper">
                    <table class="ai-table">
                        <colgroup>
                            <col style="width: 5%">  <col style="width: 12%"> <col style="width: 25%"> <col style="width: 8%">  <col style="width: 10%"> <col style="width: 12%"> <col style="width: 10%"> <col style="width: 18%"> </colgroup>
                        <thead>
                        <tr>
                            <th>No</th>
                            <th>카테고리</th>
                            <th>설문지 제목 (클라이언트 노출)</th>
                            <th>문항 수</th>
                            <th>AI 가중치</th>
                            <th>최종 수정일</th>
                            <th>상태</th>
                            <th>콘텐츠 관리</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>1</td>
                            <td>투자 성향</td>
                            <td style="font-weight: bold; text-align: left !important; padding-left: 15px;">글로벌 시장 트렌드 및 위험 감수성 조사</td>
                            <td>12문항</td>
                            <td><span style="color:#d32f2f; font-weight:bold;">High</span></td>
                            <td>2024-12-01</td>
                            <td><span class="survey-active">사용중</span></td>
                            <td>
                                <button class="btn-detail">문항 수정</button>
                                <button class="btn-detail" style="color:#666;">미리보기</button>
                            </td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>소비/지출</td>
                            <td style="font-weight: bold; text-align: left !important; padding-left: 15px;">환테크 입문자용 기초 설문</td>
                            <td>8문항</td>
                            <td><span style="color:#f57c00; font-weight:bold;">Medium</span></td>
                            <td>2024-11-20</td>
                            <td><span class="survey-active">사용중</span></td>
                            <td>
                                <button class="btn-detail">문항 수정</button>
                                <button class="btn-detail" style="color:#666;">미리보기</button>
                            </td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>목적 자금</td>
                            <td style="font-weight: bold; text-align: left !important; padding-left: 15px;">해외 여행 및 유학 자금 계획</td>
                            <td>10문항</td>
                            <td><span style="color:#f57c00; font-weight:bold;">Medium</span></td>
                            <td>2024-10-15</td>
                            <td><span class="survey-inactive">미사용</span></td>
                            <td>
                                <button class="btn-detail">문항 수정</button>
                                <button class="btn-detail" style="color:#666;">미리보기</button>
                            </td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>자산 규모</td>
                            <td style="font-weight: bold; text-align: left !important; padding-left: 15px;">고액 자산가 전용 포트폴리오 진단</td>
                            <td>15문항</td>
                            <td><span style="color:#d32f2f; font-weight:bold;">High</span></td>
                            <td>2024-12-10</td>
                            <td><span class="survey-active">사용중</span></td>
                            <td>
                                <button class="btn-detail">문항 수정</button>
                                <button class="btn-detail" style="color:#666;">미리보기</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </section>
        </div>

        <div id="surveyModal" class="survey-modal-overlay" aria-hidden="true">
            <div class="survey-modal" role="dialog" aria-modal="true" aria-labelledby="surveyModalTitle">
                <div class="survey-modal-header">
                    <h3 id="surveyModalTitle">설문 등록</h3>
                    <button type="button" class="survey-modal-close" aria-label="닫기">×</button>
                </div>
                <div class="survey-modal-body">
                    <div class="survey-form-section">
                        <div class="survey-form-row">
                            <div class="survey-col-6">
                                <label for="surveyTitle">설문 제목</label>
                                <input type="text" id="surveyTitle" class="survey-input" placeholder="설문 제목을 입력하세요">
                            </div>
                            <div class="survey-col-6">
                                <label for="surveyActive">사용 여부</label>
                                <select id="surveyActive" class="survey-select">
                                    <option value="Y">사용</option>
                                    <option value="N">미사용</option>
                                </select>
                            </div>
                        </div>
                        <div class="survey-form-row">
                            <div class="survey-col-12">
                                <label for="surveyDescription">설문 설명</label>
                                <textarea id="surveyDescription" class="survey-textarea" placeholder="설문 설명을 입력하세요"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="survey-form-section">
                        <div class="survey-question-header">
                            <div class="survey-question-title">문항 구성</div>
                            <button type="button" class="survey-btn survey-btn-light" id="addQuestionBtn">문항 추가</button>
                        </div>
                        <div id="surveyQuestionList"></div>
                    </div>
                </div>
                <div class="survey-modal-footer">
                    <button type="button" class="survey-btn-cancel" id="surveyCancelBtn">취소</button>
                    <button type="button" class="survey-btn-save" id="surveySaveBtn">저장</button>
                </div>
            </div>
        </div>

    </section>

</th:block>

<th:block th:fragment="script">
    <script th:inline="javascript">
        const baseUrl = [[@{/}]];
        $(document).ready(function() {
            console.log("AI 상품 추천 및 설문 관리 페이지 로드 완료");

            // 버튼 클릭 이벤트 예시
            $('.btn-push').click(function() {
                alert('해당 고객에게 푸시 알림을 발송했습니다.');
            });

            $('.btn-create').click(function() {
                openSurveyModal();
            });

            $('#surveyCancelBtn, .survey-modal-close').click(function() {
                closeSurveyModal();
            });

            $('#surveyModal').on('click', function(event) {
                if (event.target.id === 'surveyModal') {
                    closeSurveyModal();
                }
            });

            $('#addQuestionBtn').click(function() {
                addQuestionCard();
            });

            $('#surveySaveBtn').click(function() {
                submitSurvey();
            });

            addQuestionCard();
        });

        function openSurveyModal() {
            $('#surveyModal').addClass('active').attr('aria-hidden', 'false');
        }

        function closeSurveyModal() {
            $('#surveyModal').removeClass('active').attr('aria-hidden', 'true');
        }

        function addQuestionCard() {
            const index = $('.survey-question-card').length + 1;
            const card = $(`
                <div class="survey-question-card" data-index="${index}">
                    <div class="survey-question-header">
                        <div class="survey-question-title">문항 ${index}</div>
                        <button type="button" class="survey-btn survey-btn-light remove-question">삭제</button>
                    </div>
                    <div class="survey-form-row">
                        <div class="survey-col-12">
                            <label>질문 내용</label>
                            <input type="text" class="survey-input question-text" placeholder="질문을 입력하세요">
                        </div>
                    </div>
                    <div class="survey-form-row">
                        <div class="survey-col-6">
                            <label>질문 유형</label>
                            <select class="survey-select question-type">
                                <option value="SINGLE">단일 선택</option>
                                <option value="MULTI">다중 선택</option>
                                <option value="TEXT">주관식</option>
                            </select>
                        </div>
                        <div class="survey-col-6">
                            <label>필수 여부</label>
                            <select class="survey-select question-required">
                                <option value="Y">필수</option>
                                <option value="N">선택</option>
                            </select>
                        </div>
                    </div>
                    <div class="survey-form-row question-multi-row" style="display: none;">
                        <div class="survey-col-6">
                            <label>최대 선택 수</label>
                            <input type="number" class="survey-input question-max" min="1" placeholder="예: 2">
                        </div>
                    </div>
                    <div class="survey-form-row question-option-row">
                        <div class="survey-col-12">
                            <label>선택지</label>
                            <div class="survey-option-list"></div>
                            <button type="button" class="survey-btn survey-btn-light add-option">선택지 추가</button>
                        </div>
                    </div>
                </div>
            `);
            card.find('.remove-question').click(function() {
                card.remove();
                renumberQuestions();
            });
            card.find('.question-type').change(function() {
                toggleQuestionType(card, $(this).val());
            });
            card.find('.add-option').click(function() {
                addOptionRow(card.find('.survey-option-list'));
            });
            addOptionRow(card.find('.survey-option-list'));
            $('#surveyQuestionList').append(card);
            toggleQuestionType(card, card.find('.question-type').val());
        }

        function renumberQuestions() {
            $('.survey-question-card').each(function(index) {
                $(this).attr('data-index', index + 1);
                $(this).find('.survey-question-title').text(`문항 ${index + 1}`);
            });
        }

        function toggleQuestionType(card, type) {
            if (type === 'TEXT') {
                card.find('.question-option-row').hide();
                card.find('.question-multi-row').hide();
            } else if (type === 'MULTI') {
                card.find('.question-option-row').show();
                card.find('.question-multi-row').show();
            } else {
                card.find('.question-option-row').show();
                card.find('.question-multi-row').hide();
            }
        }

        function addOptionRow(container) {
            const count = container.children().length + 1;
            const row = $(`
                <div class="survey-option-row">
                    <input type="text" class="survey-input option-code" placeholder="코드 예: A" value="O${count}">
                    <input type="text" class="survey-input option-text" placeholder="선택지 텍스트">
                    <input type="text" class="survey-input option-value" placeholder="값(옵션)">
                    <button type="button" class="survey-btn survey-btn-light remove-option">삭제</button>
                </div>
            `);
            row.find('.remove-option').click(function() {
                row.remove();
            });
            container.append(row);
        }

        function submitSurvey() {
            const payload = {
                title: $('#surveyTitle').val(),
                description: $('#surveyDescription').val(),
                isActive: $('#surveyActive').val(),
                questions: []
            };

            $('.survey-question-card').each(function() {
                const card = $(this);
                const type = card.find('.question-type').val();
                const question = {
                    text: card.find('.question-text').val(),
                    type: type,
                    isRequired: card.find('.question-required').val(),
                    maxSelect: type === 'MULTI' ? parseInt(card.find('.question-max').val(), 10) || null : null,
                    options: []
                };
                if (type !== 'TEXT') {
                    card.find('.survey-option-row').each(function(index) {
                        const row = $(this);
                        question.options.push({
                            optCode: row.find('.option-code').val() || `O${index + 1}`,
                            optText: row.find('.option-text').val(),
                            optValue: row.find('.option-value').val(),
                            optOrder: index + 1
                        });
                    });
                }
                payload.questions.push(question);
            });

            $.ajax({
                url: `${baseUrl}admin/ai-product/surveys`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function() {
                    alert('설문이 저장되었습니다.');
                    closeSurveyModal();
                },
                error: function() {
                    alert('설문 저장에 실패했습니다.');
                }
            });
        }
    </script>
</th:block>

</html>
