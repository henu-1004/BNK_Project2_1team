<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{admin/admin_template :: admin_template('ì™¸í™”ì˜ˆê¸ˆ ê´€ë¦¬','ì™¸í™”ì˜ˆê¸ˆ ê´€ë¦¬',~{::content},~{::script})}">

<th:block th:fragment="content">
    <style>
        /* ============================
           ê¸°ë³¸ ì¹´ë“œ ìŠ¤íƒ€ì¼
        ============================= */
        .ai-card-preview {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
            font-family: 'Pretendard', sans-serif;
        }

        .preview-header {
            background-color: #1e3a8a;
            color: white;
            padding: 24px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preview-header h3 { margin: 0 0 6px 0; font-size: 20px; font-weight: 700; color: white;}
        .preview-header p { margin: 0; font-size: 13px; opacity: 0.8; font-weight: 400; color: #dbeafe;}
        .preview-flag { font-size: 32px; font-weight: 700; letter-spacing: -1px; }

        .preview-body {
            padding: 30px;
            display: flex;
            gap: 30px;
        }

        .preview-text-area { flex: 1.5; }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 20px;
            margin-bottom: 16px;
        }

        .preview-desc {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }
        .preview-desc strong { color: #1e3a8a; font-weight: 700; background: #eff6ff; padding: 2px 4px; border-radius: 4px; }

        .preview-visual-area {
            flex: 1;
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #f1f5f9;
        }

        .circle-chart {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            background: #e2e8f0;
        }

        .circle-chart::before {
            content: "";
            position: absolute;
            width: 84px;
            height: 84px;
            background: #f8fafc;
            border-radius: 50%;
        }

        .chart-text {
            position: relative;
            z-index: 2;
            font-size: 22px;
            font-weight: 800;
            color: #1e3a8a;
        }

        .visual-label { font-size: 13px; color: #64748b; margin-top: 4px; font-weight: 500;}
        .visual-icon { font-size: 24px; margin-top: 16px; }

        .edit-controls {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px dashed #cbd5e1;
        }
        .edit-controls label { font-size: 12px; font-weight: bold; color: #475569; display: block; margin-bottom: 4px;}
        .edit-controls input, .edit-controls textarea {
            width: 100%; border: 1px solid #cbd5e1; padding: 8px; border-radius: 4px; font-size: 13px; margin-bottom: 10px;
        }

        /* ============================
           ğŸ†• ì›Œë“œ í´ë¼ìš°ë“œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼
        ============================= */

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-sentiment {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
            font-weight: 600;
        }
        .btn-sentiment:hover { opacity: 0.9; }

        /* ëª¨ë‹¬ ë°°ê²½ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active { display: flex; }

        /* ëª¨ë‹¬ ë°•ìŠ¤ */
        .modal-content {
            background: #fff;
            width: 900px; /* ë„“ê²Œ ì„¤ì • */
            max-width: 95%;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
            font-family: 'Pretendard', sans-serif;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #1e3a8a;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .modal-header h3 { margin: 0; font-size: 18px; font-weight: 700; }
        .btn-close-modal {
            background: none; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.8;
        }
        .btn-close-modal:hover { opacity: 1; }
        .modal-body { padding: 24px; }

        /* í´ë¼ìš°ë“œ ì»¨í…Œì´ë„ˆ (ì¢Œìš° ë°°ì¹˜) */
        .sentiment-cloud-container {
            display: flex;
            gap: 20px;
            height: 350px; /* ë†’ì´ ê³ ì • */
        }

        /* ê¸ì •/ë¶€ì • ë°•ìŠ¤ ê³µí†µ */
        .cloud-box {
            flex: 1;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            background: #fff;
            overflow: hidden;
        }

        /* í—¤ë” (ì  + ê¸ì • + %) */
        .cloud-header {
            padding: 14px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 700;
            background: #f8fafc;
        }

        .dot-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-pos { background-color: #3b82f6; } /* íŒŒë‘ */
        .dot-neg { background-color: #ef4444; } /* ë¹¨ê°• */

        .cloud-title { color: #333; }
        .cloud-percent { color: #64748b; font-weight: 400; font-size: 13px; margin-left: 2px; }

        /* ì›Œë“œ í´ë¼ìš°ë“œ ì˜ì—­ (ë‹¨ì–´ë“¤ì´ ë– ë‹¤ë‹ ê³µê°„) */
        .cloud-area {
            flex: 1;
            position: relative; /* ì ˆëŒ€ ìœ„ì¹˜ ë°°ì¹˜ë¥¼ ìœ„í•´ */
            padding: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #ffffff 0%, #fafafa 100%);
        }

        /* ê°œë³„ ë‹¨ì–´ ìŠ¤íƒ€ì¼ */
        .cloud-word {
            position: absolute;
            white-space: nowrap;
            line-height: 1.2;
            transition: all 0.3s ease;
            cursor: default;
            user-select: none;
        }
        .cloud-word:hover { transform: translate(-50%, -50%) scale(1.1) !important; z-index: 100 !important; }

        /* í¬ê¸°ë³„ ìŠ¤íƒ€ì¼ */
        .size-l { font-size: 22px; font-weight: 800; z-index: 10; }
        .size-m { font-size: 16px; font-weight: 600; z-index: 5; opacity: 0.85; }
        .size-s { font-size: 13px; font-weight: 400; z-index: 1; opacity: 0.6; }

        /* ìƒ‰ìƒ í…Œë§ˆ - ê¸ì • (íŒŒë‘) */
        .pos-text.size-l { color: #2563eb; }
        .pos-text.size-m { color: #3b82f6; }
        .pos-text.size-s { color: #60a5fa; }

        /* ìƒ‰ìƒ í…Œë§ˆ - ë¶€ì • (ë¹¨ê°•) */
        .neg-text.size-l { color: #dc2626; }
        .neg-text.size-m { color: #ef4444; }
        .neg-text.size-s { color: #f87171; }

        /* ============================
           ğŸ†• AI 3ì¤„ ìš”ì•½ ì„¹ì…˜ ìŠ¤íƒ€ì¼
        ============================= */
        .ai-summary-section {
            margin-top: 20px;
            background-color: #f8fafc; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 700;
            color: #1e3a8a; /* í—¤ë” ìƒ‰ìƒ */
            margin-bottom: 12px;
        }

        .summary-icon { font-size: 18px; }

        .summary-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #475569;
            line-height: 1.5;
        }
        .summary-item:last-child { margin-bottom: 0; }

        /* ì²´í¬ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .check-icon {
            color: #3b82f6;
            font-weight: bold;
            margin-top: 2px; /* í…ìŠ¤íŠ¸ ì¤„ë§ì¶¤ */
        }

        /* ============================
           ğŸ†• ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
        ============================= */
        .download-group {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .btn-down {
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            font-family: 'Pretendard', sans-serif;
            letter-spacing: 0.5px;
        }

        /* PDF ë²„íŠ¼ (ë¹¨ê°„ìƒ‰ ê³„ì—´) */
        .btn-pdf {
            background-color: #ef4444;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        .btn-pdf:hover { background-color: #dc2626; transform: translateY(-1px); }

        /* Excel ë²„íŠ¼ (ì´ˆë¡ìƒ‰ ê³„ì—´) */
        .btn-excel {
            background-color: #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .btn-excel:hover { background-color: #059669; transform: translateY(-1px); }
    </style>
    <div class="product-container">

        <section class="product-card">
            <h2 class="product-title">ì™¸í™”ì˜ˆê¸ˆ ìƒí’ˆ ë“±ë¡</h2>

            <form id="foreignDepositForm"
                  th:action="@{/admin/products/register}"
                  method="post"
                  enctype="multipart/form-data">

                <div class="form-section">
                    <h3>ìƒí’ˆì„¤ëª…ì„œ AI ë¶„ì„ ì¤€ë¹„</h3>

                    <div class="form-group">
                        <label for="dpstInfoPdfUpload">PDF íŒŒì¼ ì„ íƒ</label>
                        <div class="pdf-upload-controls">
                            <input type="file" id="dpstInfoPdfUpload" accept=".pdf" />
                            <button type="button" id="btnPdfUpload" class="btn-secondary">ì—…ë¡œë“œ</button>
                        </div>
                    </div>

                    <div id="pdf-progress-box"
                         style="display:none; margin:10px 0; padding:10px; background:#f5f7fa; border-radius:6px;">
                        <div style="font-weight:bold; margin-bottom:5px;">
                            AI ë¶„ì„ ì§„í–‰ë¥ :
                            <span id="pdf-progress-text">0%</span>
                        </div>
                        <div style="width:100%; background:#e1e4e8; height:12px; border-radius:6px;">
                            <div id="pdf-progress-bar"
                                 style="width:0%; height:100%; background:#4A90E2; border-radius:6px; transition:width 0.3s;"></div>
                        </div>
                    </div>
                    <div class="pdf-list">
                        <div class="pdf-list-header" id="pdfListHeader">
                            <div class="pdf-list-title">
                                <span class="pdf-list-arrow" id="pdfListArrow">â–²</span>
                                <span>ì—…ë¡œë“œëœ PDF ëª©ë¡</span>
                            </div>
                            <span class="status-legend">ìƒíƒœ: wait / done / used</span>
                        </div>
                        <div class="pdf-list-body" id="pdfListBody">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pdfSelector">AI ë¶„ì„ ì™„ë£Œ PDF ì„ íƒ (doneë§Œ ì„ íƒ ê°€ëŠ¥)</label>
                        <select id="pdfSelector" name="donePdf" class="pdf-select">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <input type="hidden" id="selectedPdfPath" name="selectedPdfPath" />
                    <input type="hidden" id="selectedPdfName" name="selectedPdfName" />
                    <input type="hidden" id="selectedPdfId" name="selectedPdfId" />
                    <div id="selectedPdfNotice" class="selected-pdf-notice" style="display:none;"></div>

                    <div class="ai-comment-box">
                        <div id="aiRiskBlockMessage" class="risk-block-message" style="display:none;">
                            ìœ„í—˜ ìƒí’ˆì„¤ëª…ì„œ â†’ ìƒí’ˆ ë“±ë¡ ë¶ˆê°€
                        </div>
                        <div class="ai-comment-header">
                            <h4>AI ë¶„ì„ ì½”ë©˜íŠ¸</h4>
                            <span class="ai-comment-status" id="aiRiskBadge">AI ë¶„ì„ ì½”ë©˜íŠ¸ í‘œì‹œ ì˜ˆì •</span>
                        </div>
                        <div id="aiCommentContent" class="ai-comment-content">
                            <p class="ai-comment-placeholder">AI ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìƒì„±ëœ ì½”ë©˜íŠ¸ê°€ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>AI ìš”ì•½ ì¹´ë“œ ì„¤ì •</h3>

                    <div class="ai-card-preview">
                        <div class="preview-header">
                            <div>
                                <h3 id="previewTitle">ìƒí’ˆëª… í‘œì‹œ ì˜ì—­</h3>
                                <p>ë³µì¡í•œ ìƒí’ˆ ì„¤ëª…, AIê°€ 3ì¤„ë¡œ ì •ë¦¬í–ˆì–´ìš”!</p>
                            </div>
                            <div class="preview-flag" id="previewFlag">US</div>
                        </div>

                        <div class="preview-body">
                            <div class="preview-body">
                                <div class="preview-text-area">
                                    <span class="ai-badge">âœ¨ AI í•µì‹¬ ìš”ì•½</span>
                                    <div class="preview-desc" id="previewDesc">ì•„ì§ AI ë¶„ì„ ì „ì…ë‹ˆë‹¤.</div>
                                </div>

                                <div class="preview-visual-area">
                                    <div class="circle-chart" id="previewChart" style="background: conic-gradient(#1e3a8a 0% 0%, #e2e8f0 0% 100%);">
                                        <span class="chart-text" id="previewRate">0%</span>
                                    </div>
                                    <div class="visual-label">ìµœëŒ€ ì˜ˆìƒ ê¸ˆë¦¬</div>

                                    <div id="benefitSection" style="text-align: center;">
                                        <div class="visual-icon" id="previewIcon">ğŸ</div>
                                        <div class="visual-label" id="previewBenefit">ê²½í’ˆ í˜œíƒ í¬í•¨</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="edit-controls">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label>ğŸ¤– AI ìƒì„± ë°ì´í„° ìˆ˜ì •</label>
                            <button type="button" id="btnGenSummary" class="btn-secondary" style="font-size: 11px; padding: 3px 8px;">âœ¨ AI ë‚´ìš© ë‹¤ì‹œ ìƒì„±</button>
                        </div>

                        <label>ìš”ì•½ í…ìŠ¤íŠ¸</label>
                        <textarea id="aiSummaryInput" name="aiSummary" rows="3" placeholder="AI ìš”ì•½ë¬¸"></textarea>

                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label>ê°•ì¡° ê¸ˆë¦¬ (%)</label>
                                <input type="number" id="aiRateInput" name="aiRate" step="0.1" placeholder="5.2" />
                            </div>
                            <div style="flex: 1;">
                                <label>ëŒ€í‘œ í†µí™”</label>
                                <input type="text" id="aiCurrencyInput" name="aiCurrency" placeholder="US" />
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 0.3;">
                                <label>ì•„ì´ì½˜(ì´ëª¨ì§€)</label>
                                <input type="text" id="aiIconInput" name="aiIcon" placeholder="ğŸ" style="text-align: center;" />
                            </div>
                            <div style="flex: 1;">
                                <label>ì¶”ê°€ í˜œíƒ ë¬¸êµ¬ (ë¹„ì›Œë‘ë©´ ìˆ¨ê¹€)</label>
                                <input type="text" id="aiBenefitInput" name="aiBenefit" placeholder="ì˜ˆ: ê²½í’ˆ í˜œíƒ í¬í•¨, ë¹„ê³¼ì„¸ ì ìš© ë“±" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>ê¸°ë³¸ì •ë³´</h3>
                    <div class="form-group">
                        <label for="dpstName">ìƒí’ˆëª…</label>
                        <input type="text" id="dpstName" name="dpstName" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                    </div>
                    <div class="form-group">
                        <label for="dpstInfo">ìƒí’ˆ í•œ ì¤„ ì„¤ëª…</label>
                        <input type="text" id="dpstInfo" name="dpstInfo" placeholder="ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
                    </div>
                    <div class="form-group">
                        <label>ì˜ˆê¸ˆ ìœ í˜•</label>
                        <div class="radio-group">
                            <label><input type="radio" name="dpstType" value="1" checked /> ê±°ì¹˜ì‹ ì˜ˆê¸ˆ</label>
                            <label><input type="radio" name="dpstType" value="2" /> ììœ  ì ë¦½ì‹</label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>í†µí™” ë° ê¸ˆì•¡ ì„¤ì •</h3>
                    <div class="form-group">
                        <label>ê°€ëŠ¥í•œ í†µí™”</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="dpstCurrency" value="USD" /> USD(ë¯¸êµ­ ë‹¬ëŸ¬)</label>
                            <label><input type="checkbox" name="dpstCurrency" value="JPY" /> JPY(ì¼ë³¸ ì—”í™”)</label>
                            <label><input type="checkbox" name="dpstCurrency" value="EUR" /> EUR(ìœ ë¡œí™”)</label>
                            <label><input type="checkbox" name="dpstCurrency" value="GBP" /> GBP(ì˜êµ­ íŒŒìš´ë“œ)</label>
                            <label><input type="checkbox" name="dpstCurrency" value="CNH" /> CNH(ì¤‘êµ­ ìœ„ì•ˆ)</label>
                            <label><input type="checkbox" name="dpstCurrency" value="AUD" /> AUD(í˜¸ì£¼ ë‹¬ëŸ¬)</label>
                        </div>
                    </div>
                    <div class="conditional deposit-type" data-type="1">
                        <div id="currencyAmountContainer"></div>
                        <div class="form-group">
                            <label>ì¶”ê°€ë‚©ì… ê°€ëŠ¥ ì—¬ë¶€</label>
                            <div class="radio-group">
                                <label><input type="radio" name="dpstAddPayYn" value="Y" /> ê°€ëŠ¥</label>
                                <label><input type="radio" name="dpstAddPayYn" value="N" checked /> ë¶ˆê°€ëŠ¥</label>
                            </div>
                        </div>
                        <div class="conditional extra-deposit">
                            <div class="form-group">
                                <label>ì‹ ê·œ í¬í•¨ ìµœëŒ€ ë‚©ì… íšŸìˆ˜</label>
                                <input type="number" name="dpstAddPayMax" placeholder="ì˜ˆ: 3" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>í™˜ìœ¨ ì ìš© ê¸°ì¤€</h3>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstRateType" value="1" checked /> ê°€ì… ì‹œì </label>
                        <label><input type="radio" name="dpstRateType" value="2" /> ë§Œê¸° ì‹œì </label>
                        <label><input type="radio" name="dpstRateType" value="3" /> ë‚©ì… ì‹œ í™˜ìœ¨</label>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ìƒí’ˆ ì •ë³´</h3>
                    <div class="form-group">
                        <label for="dpstDescript">ìƒí’ˆ ê°œìš”</label>
                        <textarea id="dpstDescript" name="dpstDescript" rows="3" placeholder="ìƒí’ˆ íŠ¹ì§• ë° ì•ˆë‚´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ìƒí’ˆ ê°€ì…ê¸°ê°„ ìœ í˜•</label>
                        <div class="radio-group">
                            <label><input type="radio" name="dpstPeriodType" value="1" checked /> ììœ í˜•</label>
                            <label><input type="radio" name="dpstPeriodType" value="2" /> ê³ ì •í˜•</label>
                        </div>
                    </div>
                    <div class="conditional join-type" data-type="1">
                        <div class="form-inline">
                            <label>ìµœì†Œ ê°€ì…ì›”ìˆ˜</label>
                            <input type="number" name="minMonths" placeholder="ì˜ˆ: 1" /> ê°œì›”
                        </div>
                        <div class="form-inline">
                            <label>ìµœëŒ€ ê°€ì…ì›”ìˆ˜</label>
                            <input type="number" name="maxMonths" placeholder="ì˜ˆ: 36" /> ê°œì›”
                        </div>
                    </div>
                    <div class="conditional join-type" data-type="2">
                        <div class="form-group">
                            <label>ê°€ì… ê°€ëŠ¥í•œ ê°œì›”ìˆ˜</label>
                            <input type="text" name="fixedMonths" placeholder="ì˜ˆ: 3,6,12" />
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ê°€ì… ëŒ€ìƒ</h3>
                    <div class="radio-group">
                        <label><input type="radio" name="ageLimit" value="none" checked /> ì œí•œ ì—†ìŒ</label>
                        <label><input type="radio" name="ageLimit" value="yes" /> ì œí•œ ìˆìŒ</label>
                    </div>
                    <div class="conditional age-limit">
                        <div class="form-inline">
                            <label>ìµœì†Œ ë‚˜ì´</label>
                            <input type="number" name="dpstMinAge" placeholder="ì˜ˆ: 19" /> ì„¸
                        </div>
                        <div class="form-inline">
                            <label>ìµœëŒ€ ë‚˜ì´</label>
                            <input type="number" name="dpstMaxAge" placeholder="ì˜ˆ: 65" /> ì„¸
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ë¶„í•  ì¸ì¶œ ì„¤ì •</h3>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstPartWdrwYn" value="Y" /> ê°€ëŠ¥</label>
                        <label><input type="radio" name="dpstPartWdrwYn" value="N" checked /> ë¶ˆê°€ëŠ¥</label>
                    </div>
                    <div class="conditional partial-withdrawal">
                        <div class="form-group">
                            <label>ê°€ëŠ¥ ì‹œì  (ê°€ì… í›„)</label>
                            <input type="number" name="withdrawAfterMonths" placeholder="ì˜ˆ: 6" /> ê°œì›” ì´í›„
                        </div>
                        <div class="form-group">
                            <label>ìµœëŒ€ ì¸ì¶œ ê°€ëŠ¥ íšŸìˆ˜</label>
                            <input type="number" name="withdrawCount" placeholder="ì˜ˆ: 3íšŒ" />
                        </div>
                        <div id="withdrawCurrencyContainer"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ìë™ì—°ì¥ ì„¤ì •</h3>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstAutoRenewYn" value="Y" /> ê°€ëŠ¥</label>
                        <label><input type="radio" name="dpstAutoRenewYn" value="N" checked /> ë¶ˆê°€ëŠ¥</label>
                    </div>
                    <div class="conditional auto-renew">
                        <div class="form-group">
                            <label>ì—°ì¥ ê¸°ê°„ ì„ íƒ</label>
                            <select name="renewPeriod">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="1">1ê°œì›”</option>
                                <option value="3">3ê°œì›”</option>
                                <option value="6">6ê°œì›”</option>
                                <option value="12">12ê°œì›”</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ìƒí’ˆì„¤ëª…ì„œ ì²¨ë¶€</h3>
                    <div class="form-group">
                        <input type="file" name="pdfFile" accept=".pdf,.doc,.docx" />
                    </div>
                </div>

                <div class="form-section">
                    <h3>ìƒí’ˆ ê°œì‹œì¼ì</h3>
                    <div class="form-group">
                        <label for="dpstRegDt">ê°œì‹œì¼ì ì„ íƒ</label>
                        <input type="date" id="dpstRegDt" name="dpstRegDt" required />
                    </div>
                </div>

                <div class="form-submit">
                    <button type="submit" class="btn-submit">ë“±ë¡í•˜ê¸°</button>
                </div>

            </form> </section>



        <section class="product-card">

            <h2 class="product-title">ì™¸í™”ì˜ˆê¸ˆ ìƒí’ˆ ê´€ë¦¬</h2>

            <div class="product-tabs">
                <button class="tab-btn active" data-status="approve">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</button>
                <button class="tab-btn" data-status="pending">ìƒí’ˆ ë“±ë¡ ëŒ€ê¸° ì¤‘</button>
            </div>

            <div class="product-table-wrap" data-status-group="approve">
                <table class="product-table">
                    <thead>
                    <tr>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${approveList}" data-status="approve" th:data-id="${p.dpstId}">
                        <td th:text="${p.dpstName}"></td>
                        <td><span class="status-badge status-approve">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</span></td>
                        <td><button class="btn-approve">ìŠ¹ì¸</button></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="product-table-wrap" data-status-group="pending" style="display:none;">
                <table class="product-table">
                    <thead>
                    <tr>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìƒíƒœ</th>
                        <th>ìƒí’ˆ ê°œì‹œì¼</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${pendingList}" th:data-id="${p.dpstId}">
                        <td th:text="${p.dpstName}"></td>
                        <td><span class="status-badge status-pending">ìƒí’ˆ ë“±ë¡ ëŒ€ê¸° ì¤‘</span></td>
                        <td th:text="${p.dpstRegDt}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </section>


        <section class="product-card">
            <h2 class="product-title">ì™¸í™”ì˜ˆê¸ˆ ìƒí’ˆ í˜„í™©</h2>

            <div class="product-table-wrap">
                <table class="product-table">
                    <thead>
                    <tr>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìƒí’ˆíŒë§¤ê°œì‹œì¼ì‹œ</th>
                        <th>ìƒíƒœ</th>
                        <th>AI ë°˜ì‘ ë¶„ì„</th>
                        <th>ìƒí’ˆ ìš”ì•½</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr th:each="p : ${saleList}">
                        <td>
                            <a th:href="@{/admin/products/view/{id}(id=${p.dpstId})}"
                               class="product-link"
                               th:text="${p.dpstName}"></a>
                        </td>
                        <td th:text="${p.dpstRegDt}"></td>
                        <td><span class="status-badge status-sale">íŒë§¤ì¤‘</span></td>
                        <td>
                            <button type="button" class="btn-sentiment"
                                    th:onclick="openSentimentModal([[${p.dpstId}]], [[${p.dpstName}]])">
                                ë¶„ì„ ë³´ê¸°
                            </button>
                        </td>
                        <td>
                            <div class="download-group">
                                <button type="button" class="btn-down btn-pdf" title="PDF ë‹¤ìš´ë¡œë“œ"
                                        th:onclick="downloadSummary('pdf', [[${p.dpstName}]])">PDF</button>
                                <button type="button" class="btn-down btn-excel" title="Excel ë‹¤ìš´ë¡œë“œ"
                                        th:onclick="downloadSummary('excel', [[${p.dpstName}]])">XLXS</button>
                            </div>
                        </td>
                    </tr>

                    <tr th:each="p : ${stopList}">
                        <td>
                            <a th:href="@{/admin/products/view/{id}(id=${p.dpstId})}"
                               class="product-link"
                               th:text="${p.dpstName}"></a>
                        </td>
                        <td th:text="${p.dpstRegDt}"></td>
                        <td><span class="status-badge status-stop">íŒë§¤ì¤‘ë‹¨</span></td>
                        <td>
                            <button type="button" class="btn-sentiment"
                                    th:onclick="openSentimentModal([[${p.dpstId}]], [[${p.dpstName}]])">
                                ë¶„ì„ ë³´ê¸°
                            </button>
                        </td>
                        <td>
                            <div class="download-group">
                                <button type="button" class="btn-down btn-pdf" title="PDF ë‹¤ìš´ë¡œë“œ"
                                        th:onclick="downloadSummary('pdf', [[${p.dpstName}]])">PDF</button>
                                <button type="button" class="btn-down btn-excel" title="Excel ë‹¤ìš´ë¡œë“œ"
                                        th:onclick="downloadSummary('excel', [[${p.dpstName}]])">XLS</button>
                            </div>
                        </td>
                    </tr>

                    </tbody>
                </table>
            </div>
        </section>

        <div id="sentimentModal" class="modal-overlay">
            <div class="modal-content" style="width: 800px; max-width: 95%;"> <div class="modal-header">
                <h3 id="modalProductTitle">ìƒí’ˆëª… AI ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                <button type="button" class="btn-close-modal" onclick="closeSentimentModal()">Ã—</button>
            </div>
                <div class="modal-body">

                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333; font-weight: 700;">ê¸Â·ë¶€ì • í‚¤ì›Œë“œ ë¶„ì„</h4>

                    <div class="sentiment-cloud-container">
                        <div class="cloud-box positive-box">
                            <div class="cloud-header">
                                <span class="dot-indicator dot-pos"></span>
                                <span class="cloud-title">ê¸ì •</span>
                                <span class="cloud-percent" id="posPercentTitle">0%</span>
                            </div>
                            <div id="posWordCloud" class="cloud-area"></div>
                        </div>

                        <div class="cloud-box negative-box">
                            <div class="cloud-header">
                                <span class="dot-indicator dot-neg"></span>
                                <span class="cloud-title">ë¶€ì •</span>
                                <span class="cloud-percent" id="negPercentTitle">0%</span>
                            </div>
                            <div id="negWordCloud" class="cloud-area"></div>
                        </div>
                    </div>

                    <div class="ai-summary-section">
                        <div class="summary-header">
                            <span>AI ë¶„ì„ 3ì¤„ ìš”ì•½</span>
                        </div>
                        <div id="ai3LineSummary" class="summary-content">
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</th:block>

<th:block th:fragment="script">

    <script>
        /* ============================
           SSE ì „ì—­ ë³€ìˆ˜
        ============================= */
        let currentEventSource = null;
        let currentPdfData = null;

        const AI_PLACEHOLDER = "AI ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìƒì„±ëœ ì½”ë©˜íŠ¸ê°€ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.";

        /* ============================
           ğŸ¨ 1. AI ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ë¡œì§
        ============================= */
        // UI ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const ui = {
            summaryInput: document.getElementById('aiSummaryInput'),
            rateInput: document.getElementById('aiRateInput'),
            currencyInput: document.getElementById('aiCurrencyInput'),
            // [ì¶”ê°€] í˜œíƒ ê´€ë ¨ ì…ë ¥ì°½
            iconInput: document.getElementById('aiIconInput'),
            benefitInput: document.getElementById('aiBenefitInput'),
            nameInput: document.getElementById('dpstName'),

            previewTitle: document.getElementById('previewTitle'),
            previewDesc: document.getElementById('previewDesc'),
            previewRate: document.getElementById('previewRate'),
            previewChart: document.getElementById('previewChart'),
            previewFlag: document.getElementById('previewFlag'),
            // [ì¶”ê°€] ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œ
            previewIcon: document.getElementById('previewIcon'),
            previewBenefit: document.getElementById('previewBenefit'),
            benefitSection: document.getElementById('benefitSection')
        };

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCardPreview() {
            // í…ìŠ¤íŠ¸ ë°˜ì˜
            if(ui.previewDesc) ui.previewDesc.innerHTML = (ui.summaryInput.value || "ì•„ì§ AI ë¶„ì„ ì „ì…ë‹ˆë‹¤.<br>PDFë¥¼ ë¶„ì„í•˜ë©´ ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.").replace(/\n/g, "<br>");
            if(ui.previewTitle) ui.previewTitle.textContent = ui.nameInput.value || "ìƒí’ˆëª… í‘œì‹œ ì˜ì—­";
            if(ui.previewFlag) ui.previewFlag.textContent = ui.currencyInput.value || "US";

            // ê¸ˆë¦¬ ì°¨íŠ¸ ë°˜ì˜
            const rate = parseFloat(ui.rateInput.value) || 0;
            if(ui.previewRate) ui.previewRate.textContent = rate + "%";

            // ë„ë„› ì°¨íŠ¸ ê·¸ë¼ë°ì´ì…˜ (ìµœëŒ€ 10% ê¸°ì¤€ ì‹œê°í™”)
            const percentage = Math.min((rate / 6) * 100, 100);
            if(ui.previewChart) {
                ui.previewChart.style.background = `conic-gradient(#1e3a8a 0% ${percentage}%, #e2e8f0 ${percentage}% 100%)`;
            }

            // 2. ğŸ”¥ [í•µì‹¬] í˜œíƒ ì„¹ì…˜ ì œì–´ ë¡œì§
            const iconVal = ui.iconInput.value;
            const benefitVal = ui.benefitInput.value;

            if (!benefitVal) {
                // í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì•„ì˜ˆ ìˆ¨ê¹€
                if(ui.benefitSection) ui.benefitSection.style.display = 'none';
            } else {
                // í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë³´ì—¬ì¤Œ
                if(ui.benefitSection) ui.benefitSection.style.display = 'block';
                if(ui.previewIcon) ui.previewIcon.textContent = iconVal || "ğŸ"; // ì•„ì´ì½˜ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„ ë¬¼ìƒì
                if(ui.previewBenefit) ui.previewBenefit.textContent = benefitVal;
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ìƒˆë¡œ ì¶”ê°€ëœ inputë“¤ë„ í¬í•¨)
        [ui.summaryInput, ui.rateInput, ui.currencyInput, ui.iconInput, ui.benefitInput, ui.nameInput].forEach(input => {
            if(input) input.addEventListener('input', updateCardPreview);
        });

        /* ============================
           ğŸ¤– 2. AI ë‚´ìš© ìƒì„± ë²„íŠ¼ ë™ì‘
        ============================= */
        const btnGenSummary = document.getElementById("btnGenSummary");
        if(btnGenSummary) {
            btnGenSummary.addEventListener("click", () => {
                if (!currentPdfData) {
                    alert("ë¨¼ì € 'AI ë¶„ì„ ì™„ë£Œ PDF'ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                // ë¡œë”© í‘œì‹œ
                ui.summaryInput.value = "AIê°€ ë‚´ìš©ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...";

                setTimeout(() => {
                    // ì‹¤ì œ ë°ì´í„° ë§¤í•‘ (PDF ë¶„ì„ ê²°ê³¼ê°€ ìˆë‹¤ê³  ê°€ì •)
                    const summary = currentPdfData.productShortDesc || "PDFì—ì„œ ìš”ì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    const maxRate = currentPdfData.maxRate || 0.0; // ë°ì´í„° ì—†ìœ¼ë©´ 0.0

                    // í†µí™” ì½”ë“œ ì¶”ì¶œ (ì˜ˆ: "USD, JPY" -> "US")
                    let currency = "US";
                    if(currentPdfData.currencies) {
                        currency = currentPdfData.currencies.substring(0, 2).toUpperCase();
                    }

                    // ê°’ ì£¼ì…
                    ui.summaryInput.value = summary;
                    ui.rateInput.value = maxRate;
                    ui.currencyInput.value = currency;

                    // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
                    updateCardPreview();
                    alert("AI ìš”ì•½ ë‚´ìš©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }, 500); // 0.5ì´ˆ ë”œë ˆì´ ì—°ì¶œ
            });
        }

        /* ============================
           ğŸ“¡ SSE ì—°ê²° í•¨ìˆ˜
        ============================= */
        function connectProgressSSE(pdfId) {
            if (!pdfId) return;

            if (currentEventSource) {
                currentEventSource.close();
            }

            const url = `/flobank/pdf-ai/progress/${pdfId}`;
            console.log("ğŸ”Œ SSE ì—°ê²°:", url);

            const box = document.getElementById("pdf-progress-box");
            const bar = document.getElementById("pdf-progress-bar");
            const text = document.getElementById("pdf-progress-text");

            box.style.display = "block";

            currentEventSource = new EventSource(url);

            currentEventSource.onmessage = function (event) {

                const progress = Number(event.data);
                console.log("ğŸ“¡ SSE Progress:", progress);

                bar.style.width = `${progress}%`;
                text.textContent = `${progress}%`;

                // 100% â†’ ìë™ ì¢…ë£Œ
                if (progress >= 100) {
                    setTimeout(() => {
                        box.style.display = "none";
                        bar.style.width = "0%";
                        text.textContent = "0%";
                        currentEventSource.close();
                    }, 3000);
                }

                // ì—ëŸ¬ (-1)
                if (progress === -1) {
                    text.textContent = "ì—ëŸ¬ ë°œìƒ";
                    bar.style.background = "red";
                }
            };

            currentEventSource.onerror = function () {
                console.log("âŒ SSE ì˜¤ë¥˜ â†’ ì—°ê²° ì¢…ë£Œ");
                currentEventSource.close();
            };
        }

        /* ============================
           ğŸ“‘ í—¬í¼ í•¨ìˆ˜
        ============================= */
        function formatDateTime(value) {
            if (!value) return "";
            const date = new Date(value);
            if (isNaN(date.getTime())) return value;
            return date.toLocaleString("ko-KR", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        function resetAiCommentBox() {
            const badge = document.getElementById("aiRiskBadge");
            const content = document.getElementById("aiCommentContent");

            if (badge) {
                badge.textContent = "AI ë¶„ì„ ì½”ë©˜íŠ¸ í‘œì‹œ ì˜ˆì •";
                badge.className = "ai-comment-status";
            }

            if (content) {
                content.innerHTML = `<p class="ai-comment-placeholder">${AI_PLACEHOLDER}</p>`;
            }

            updateRiskGuard(null);
            updateSelectedPdfInputs();
        }

        function parseAiComments(aiComment, aiOverallRisk) {
            let overallRisk = aiOverallRisk || null;
            let comments = [];

            if (aiComment) {
                try {
                    const parsed = JSON.parse(aiComment);
                    overallRisk = parsed.overall_risk || parsed.overallRisk || overallRisk;
                    if (Array.isArray(parsed.comments)) {
                        comments = parsed.comments;
                    }
                } catch (e) {
                    comments = [aiComment];
                }
            }

            return { overallRisk, comments };
        }

        function updateSelectedPdfInputs(pdf) {
            const pathInput = document.getElementById("selectedPdfPath");
            const nameInput = document.getElementById("selectedPdfName");
            const idInput = document.getElementById("selectedPdfId");
            const noticeEl = document.getElementById("selectedPdfNotice");

            if (!pdf) {
                if (pathInput) pathInput.value = "";
                if (nameInput) nameInput.value = "";
                if (idInput) idInput.value = "";
                if (noticeEl) {
                    noticeEl.style.display = "none";
                    noticeEl.textContent = "";
                }
                return;
            }

            if (pathInput) pathInput.value = pdf.filePath || "";
            if (nameInput) nameInput.value = pdf.storedFileName || "";
            if (idInput) idInput.value = pdf.pdfId || "";

            if (noticeEl) {
                const filename = pdf.orgFileName || pdf.storedFileName || "ì„ íƒí•œ PDF";
                noticeEl.style.display = "block";
                noticeEl.textContent = `${filename}ê°€ ìë™ìœ¼ë¡œ ë“±ë¡ íŒŒì¼ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
        }

        function updateRiskGuard(risk) {
            const submitBtn = document.querySelector(".btn-submit");
            const blockMessage = document.getElementById("aiRiskBlockMessage");

            const normalized = (risk || "").toString().toLowerCase();
            const isDanger = normalized.includes("danger") || normalized.includes("ìœ„í—˜");

            if (submitBtn) {
                submitBtn.disabled = isDanger;
            }

            if (blockMessage) {
                blockMessage.style.display = isDanger ? "block" : "none";
            }
        }

        function buildCommentItem(comment) {
            const item = document.createElement("div");
            item.classList.add("ai-comment-item");

            if (typeof comment === "string") {
                const text = document.createElement("p");
                text.classList.add("ai-comment-text");
                text.textContent = comment;
                item.appendChild(text);
                return item;
            }

            const phrase = comment.risky_phrase || comment.riskyPhrase;
            const reason = comment.violation_reason || comment.violationReason;
            const suggestion = comment.improvement_suggestion || comment.improvementSuggestion;

            const rows = [
                { label: "ìœ„í—˜ ë¬¸êµ¬", value: phrase, className: "ai-comment-phrase" },
                { label: "ìœ„ë°˜/ë¶„ì„", value: reason, className: "ai-comment-reason" },
                { label: "ê°œì„  ë°©í–¥", value: suggestion, className: "ai-comment-suggestion" }
            ];

            rows.forEach(row => {
                if (!row.value) return;
                const rowEl = document.createElement("div");
                rowEl.className = "ai-comment-row";

                const labelEl = document.createElement("div");
                labelEl.className = "ai-comment-label";
                labelEl.textContent = row.label;

                const valueEl = document.createElement("div");
                valueEl.className = row.className;
                valueEl.textContent = row.value;

                rowEl.appendChild(labelEl);
                rowEl.appendChild(valueEl);
                item.appendChild(rowEl);
            });

            if (!phrase && !reason && !suggestion) {
                const fallback = document.createElement("p");
                fallback.classList.add("ai-comment-text");
                fallback.textContent = "ì¶”ê°€ ì½”ë©˜íŠ¸ ì—†ìŒ";
                item.appendChild(fallback);
            }

            return item;
        }

        function renderAiComments(pdf) {
            const badge = document.getElementById("aiRiskBadge");
            const content = document.getElementById("aiCommentContent");

            if (!badge || !content) return;

            const { overallRisk, comments } = parseAiComments(pdf.aiComment, pdf.aiOverallRisk);

            const riskText = overallRisk || "ë¶„ì„ ëŒ€ê¸°";
            const riskClass = riskText.toLowerCase().replace(/\s+/g, "");
            badge.textContent = `ìœ„í—˜ë„: ${riskText}`;
            badge.className = `ai-comment-status ai-risk-${riskClass}`;
            updateRiskGuard(overallRisk);

            content.innerHTML = "";

            if (!comments || comments.length === 0) {
                content.innerHTML = `<p class="ai-comment-placeholder">${AI_PLACEHOLDER}</p>`;
                return;
            }

            comments.forEach(comment => content.appendChild(buildCommentItem(comment)));
        }

        function setRadioValue(name, value) {
            if (!value) return;
            const target = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (target) {
                target.checked = true;
                target.dispatchEvent(new Event("change", { bubbles: true }));
            }
        }

        function applyPdfDataToForm(pdf) {
            if (!pdf) return;

            currentPdfData = pdf; // [ì¤‘ìš”] ë°ì´í„° ì €ì¥í•´ë‘ê¸° (ë²„íŠ¼ í´ë¦­ìš©)

            updateSelectedPdfInputs(pdf);

            const nameInput = document.getElementById("dpstName");
            const infoInput = document.getElementById("dpstInfo");
            const descriptInput = document.getElementById("dpstDescript");

            if (pdf.productName && nameInput) nameInput.value = pdf.productName;
            if (pdf.productShortDesc && infoInput) infoInput.value = pdf.productShortDesc;
            if (pdf.productFeatures && descriptInput) descriptInput.value = pdf.productFeatures;

            /* ì˜ˆê¸ˆ ìœ í˜• */
            const depositValue = (pdf.depositType || "").includes("ê±°ì¹˜") ? "1" : (pdf.depositType ? "2" : null);
            setRadioValue("dpstType", depositValue);

            /* í†µí™” */
            const currencyText = pdf.currencies || "";
            const currencyCodes = currencyText.split(/[,\s]+/).map(c => c.trim()).filter(Boolean);
            const currencyBoxes = document.querySelectorAll('input[name="dpstCurrency"]');
            currencyBoxes.forEach(box => {
                box.checked = currencyCodes.includes(box.value);
                box.dispatchEvent(new Event("change", { bubbles: true }));
            });

            /* í™˜ìœ¨ ì •ì±… */
            const policy = (pdf.exchangeRatePolicy || "").replace(/\s/g, "").toLowerCase();
            let rateValue = null;
            if (policy.includes("ë‚©ì…")) rateValue = "3";
            else if (policy.includes("ë§Œê¸°")) rateValue = "2";
            else if (policy.includes("ê°€ì…")) rateValue = "1";
            setRadioValue("dpstRateType", rateValue);

            /* ê°€ì… ê¸°ê°„ */
            const termText = pdf.termType || "";
            let joinType = null;
            if (pdf.minMonth != null || pdf.maxMonth != null || termText.includes("ììœ ")) joinType = "1";
            else if (termText) joinType = "2";
            setRadioValue("dpstPeriodType", joinType);

            const minMonths = document.querySelector('input[name="minMonths"]');
            const maxMonths = document.querySelector('input[name="maxMonths"]');
            if (minMonths && pdf.minMonth != null) minMonths.value = pdf.minMonth;
            if (maxMonths && pdf.maxMonth != null) maxMonths.value = pdf.maxMonth;

            const fixedMonthsInput = document.querySelector('input[name="fixedMonths"]');
            if (fixedMonthsInput && joinType === "2") {
                const monthsFromText = termText.match(/\d+/g);
                if (monthsFromText && monthsFromText.length > 0) fixedMonthsInput.value = monthsFromText.join(",");
                else if (termText) fixedMonthsInput.value = termText;
                fixedMonthsInput.dispatchEvent(new Event("change", { bubbles: true }));
            }

            /* ì¶”ê°€ ê¸°ëŠ¥ */
            const yesNo = (value) => {
                if (!value) return null;
                const cleaned = value.trim();
                if (cleaned.includes("ê°€ëŠ¥")) return "Y";
                if (cleaned.includes("ì—†ìŒ") || cleaned.includes("ë¶ˆê°€") || cleaned.includes("ë¶ˆê°€ëŠ¥")) return "N";
                return null;
            };
            setRadioValue("dpstAddPayYn", yesNo(pdf.additionalDeposit));
            setRadioValue("dpstAutoRenewYn", yesNo(pdf.autoRenewal));
            setRadioValue("dpstPartWdrwYn", yesNo(pdf.partialWithdrawal));

            renderAiComments(pdf);

            // PDF ì„ íƒ ì‹œ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°ë„ í•œë²ˆ ê°±ì‹  ì‹œë„
            if(ui.nameInput) ui.nameInput.dispatchEvent(new Event('input'));
        }


        /* ============================
           ğŸ“¤ PDF ì—…ë¡œë“œ
        ============================= */
        document.getElementById("btnPdfUpload").addEventListener("click", async () => {
            const fileInput = document.getElementById("dpstInfoPdfUpload");

            if (fileInput.files.length === 0) {
                alert("PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            const form = new FormData();
            form.append("file", fileInput.files[0]);

            const res = await fetch("/flobank/admin/pdf-ai/upload", {
                method: "POST",
                body: form
            });

            if (!res.ok) {
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
                return;
            }

            const result = await res.json();
            console.log("ğŸ“¦ ì—…ë¡œë“œ ì‘ë‹µ:", result);

            alert("ì—…ë¡œë“œ ì„±ê³µ!");
            loadPdfList();

            // ğŸ”¥ SSE ì—°ê²° ì‹œì‘
            connectProgressSSE(result.pdfId);
        });


        /* ============================
           âœ… PDF ì„ íƒ ì‹œ ìë™ ëŒ€ì…
        ============================= */
        async function handlePdfSelection(event) {
            const selectedId = event.target.value;

            if (!selectedId) {
                resetAiCommentBox();
                return;
            }

            try {
                const res = await fetch(`/flobank/admin/pdf-ai/${selectedId}`);

                if (!res.ok) {
                    const message = await res.text();
                    alert(message || "PDF ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    event.target.value = "";
                    resetAiCommentBox();
                    return;
                }

                const data = await res.json();
                applyPdfDataToForm(data);
            } catch (error) {
                console.error(error);
                alert("PDF ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


        /* ============================
           ğŸ“„ PDF ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        ============================= */
        async function loadPdfList() {
            try {
                const res = await fetch("/flobank/admin/pdf-ai/list");
                if (!res.ok) {
                    throw new Error("PDF ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }

                const list = await res.json();

                const body = document.getElementById("pdfListBody");
                const selector = document.getElementById("pdfSelector");

                body.innerHTML = "";
                selector.innerHTML = `<option value="">ì„ íƒí•˜ì„¸ìš”</option>`;

                list.forEach(item => {
                    const createdAt = formatDateTime(item.createdAt);
                    const riskLabel = item.aiOverallRisk ? `<span class="ai-risk-chip ai-risk-${(item.aiOverallRisk || '').toLowerCase()}">${item.aiOverallRisk}</span>` : "";

                    body.innerHTML += `
                <div class="pdf-list-item" data-pdf-id="${item.pdfId}">
                    <div>
                        <strong>${item.orgFileName}</strong>
                        <div class="pdf-meta">${createdAt}</div>
                    </div>
                    <div class="pdf-status-cluster">
                        <span class="status-chip status-${item.status}">${item.status}</span>
                        ${riskLabel}
                        <button type="button" class="pdf-delete-btn" data-pdf-id="${item.pdfId}">Ã—</button>
                    </div>
                </div>
            `;

                    if (item.status === "done") {
                        selector.innerHTML += `
                    <option value="${item.pdfId}">
                        ${item.orgFileName} (done)
                    </option>
                `;
                    }
                });

                bindPdfDeleteButtons();
            } catch (error) {
                console.error(error);
                alert(error.message || "PDF ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function bindPdfDeleteButtons() {
            const container = document.getElementById("pdfListBody");
            if (!container) return;

            container.querySelectorAll(".pdf-delete-btn").forEach(btn => {
                btn.addEventListener("click", async (event) => {
                    event.stopPropagation();
                    const pdfId = btn.getAttribute("data-pdf-id");

                    if (!pdfId) return;

                    if (!confirm("PDFë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                    const res = await fetch(`/flobank/admin/pdf-ai/${pdfId}`, { method: "DELETE" });

                    if (!res.ok) {
                        const message = await res.text();
                        alert(message || "PDF ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        return;
                    }

                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadPdfList();
                });
            });
        }

        function initPdfAccordion() {
            const header = document.getElementById("pdfListHeader");
            const body = document.getElementById("pdfListBody");
            const arrow = document.getElementById("pdfListArrow");

            if (!header || !body || !arrow) return;

            header.addEventListener("click", () => {
                const isHidden = body.style.display === "none";
                body.style.display = isHidden ? "flex" : "none";
                arrow.textContent = isHidden ? "â–²" : "â–¼";
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            initPdfAccordion();
            loadPdfList();
            const selector = document.getElementById("pdfSelector");
            if (selector) {
                selector.addEventListener("change", handlePdfSelection);
            }
            if(typeof updateCardPreview === 'function') updateCardPreview();
        });

        /* ============================
       ğŸ†• AI ê¸/ë¶€ì • ëª¨ë‹¬ ë¡œì§ (ì›Œë“œ í´ë¼ìš°ë“œ ë²„ì „)
    ============================= */

        // 1. ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
        function openSentimentModal(productId, productName) {
            const modal = document.getElementById('sentimentModal');
            const title = document.getElementById('modalProductTitle');

            if(title) title.textContent = `[${productName}] AI ë¦¬ë·° ë¶„ì„`;

            // ğŸ”¥ ê°€ì¤‘ì¹˜(weight)ê°€ í¬í•¨ëœ ë°ì´í„° ìƒì„±
            const mockData = generateMockSentimentData(productId);

            // ë°ì´í„° ë Œë”ë§ í˜¸ì¶œ
            renderSentimentData(mockData);

            if(modal) modal.classList.add('active');
        }

        // 2. ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
        function closeSentimentModal() {
            const modal = document.getElementById('sentimentModal');
            if(modal) modal.classList.remove('active');
        }

        // (ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°)
        const sentimentModal = document.getElementById('sentimentModal');
        if(sentimentModal) {
            sentimentModal.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeSentimentModal();
            });
        }

        // 3. ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ (ìˆ˜ì •ë¨: 3ì¤„ ìš”ì•½ ì¶”ê°€)
        function renderSentimentData(data) {
            // (1) í¼ì„¼íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
            const posTitle = document.getElementById('posPercentTitle');
            const negTitle = document.getElementById('negPercentTitle');

            if(posTitle) posTitle.textContent = `${data.posRate}%`;
            if(negTitle) negTitle.textContent = `${data.negRate}%`;

            // (2) ì›Œë“œ í´ë¼ìš°ë“œ ê·¸ë¦¬ê¸°
            renderWordCloud('posWordCloud', data.posKeywords, 'pos-text');
            renderWordCloud('negWordCloud', data.negKeywords, 'neg-text');

            // ğŸ†• (3) AI 3ì¤„ ìš”ì•½ ë Œë”ë§
            const summaryBox = document.getElementById('ai3LineSummary');
            if (summaryBox) {
                summaryBox.innerHTML = ''; // ì´ˆê¸°í™”
                data.summary.forEach(line => {
                    const div = document.createElement('div');
                    div.className = 'summary-item';
                    div.innerHTML = `<span class="check-icon">âœ”</span> <span>${line}</span>`;
                    summaryBox.appendChild(div);
                });
            }
        }

        // ğŸ†• 4. ì›Œë“œ í´ë¼ìš°ë“œ ë°°ì¹˜ ë¡œì§ (í•µì‹¬)
        function renderWordCloud(containerId, words, colorClass) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            words.forEach((wordObj, index) => {
                const span = document.createElement('span');
                span.textContent = wordObj.text;
                span.classList.add('cloud-word'); // ê¸°ë³¸ ìŠ¤íƒ€ì¼
                span.classList.add(colorClass);   // ìƒ‰ìƒ í…Œë§ˆ (pos-text ë˜ëŠ” neg-text)

                // ìˆœì„œ(ê°€ì¤‘ì¹˜)ì— ë”°ë¼ í¬ê¸° í´ë˜ìŠ¤ ë¶€ì—¬
                // ì²« ë²ˆì§¸ ë‹¨ì–´ëŠ” ê°€ì¥ í¬ê²Œ, ê·¸ ë’¤ë¡œ ê°ˆìˆ˜ë¡ ì‘ê²Œ
                if (index === 0) span.classList.add('size-l');       // ëŒ€í˜• (ì¤‘ì‹¬)
                else if (index < 4) span.classList.add('size-m');    // ì¤‘í˜•
                else span.classList.add('size-s');                   // ì†Œí˜•

                container.appendChild(span);

                // ğŸ² ëœë¤ ìœ„ì¹˜ ê³„ì‚° logic
                let top, left;

                if (index === 0) {
                    // ê°€ì¥ í° ë‹¨ì–´ëŠ” ì •ì¤‘ì•™(50%) ê·¼ì²˜ì— ë°°ì¹˜
                    top = 50 + (Math.random() * 10 - 5);  // 45% ~ 55%
                    left = 50 + (Math.random() * 10 - 5); // 45% ~ 55%
                } else {
                    // ë‚˜ë¨¸ì§€ ë‹¨ì–´ëŠ” ë°•ìŠ¤ ë‚´ë¶€ì— ëœë¤í•˜ê²Œ í©ë¿Œë¦¼ (ê°€ì¥ìë¦¬ ì—¬ë°± 10% ì œì™¸)
                    top = Math.random() * 80 + 10;  // 10% ~ 90%
                    left = Math.random() * 80 + 10; // 10% ~ 90%
                }

                span.style.top = `${top}%`;
                span.style.left = `${left}%`;

                // ì¢Œí‘œë¥¼ ì¤‘ì‹¬ì ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì •í™•í•œ ìœ„ì¹˜ ë°°ì¹˜
                span.style.transform = `translate(-50%, -50%)`;
            });
        }

        // 5. (ë°ëª¨ìš©) ê°€ì§œ ë°ì´í„° ìƒì„±ê¸° (ìˆ˜ì •ë¨: summary ë°°ì—´ ì¶”ê°€)
        function generateMockSentimentData(id) {
            const randomPos = Math.floor(Math.random() * 40) + 50; // 50~90%

            return {
                posRate: randomPos,
                negRate: 100 - randomPos,
                posKeywords: [
                    { text: "ì‚¬ìš©í•˜ê¸° í¸í•˜ê³  í™˜ì „ì´ ë¹¨ë¼ìš”", weight: 10 },
                    { text: "ì•Œë¦¼ì´ ìœ ìš©í•´ìš”", weight: 8 },
                    { text: "í•´ì™¸ê²°ì œ ì—°ë™ì´ í¸ë¦¬í•©ë‹ˆë‹¤", weight: 7 },
                    { text: "UI/UXê°€ ê¹”ë”í•©ë‹ˆë‹¤", weight: 6 },
                    { text: "ìˆ˜ìˆ˜ë£Œê°€ ì €ë ´í•´ì„œ ì¢‹ì•„ìš”", weight: 5 },
                    { text: "ê³ ê°ì„¼í„°ê°€ ì¹œì ˆí–ˆì–´ìš”", weight: 4 },
                    { text: "ì•ˆì •ì„±ì´ ì¢‹ì•„ì¡ŒìŠµë‹ˆë‹¤", weight: 3 },
                    { text: "ì „ì²´ì ìœ¼ë¡œ ë§Œì¡±í•©ë‹ˆë‹¤", weight: 2 },
                    { text: "ì¶”ì²œ", weight: 1 }
                ],
                negKeywords: [
                    { text: "ë³„ë¡œì˜ˆìš”", weight: 10 },
                    { text: "ë¶ˆì¹œì ˆ", weight: 8 },
                    { text: "ì•±ì´ ëŠë¦¬ë‹¤", weight: 7 },
                    { text: "ì˜¤ë¥˜", weight: 6 },
                    { text: "ì§œì¦", weight: 5 },
                    { text: "ê°œì„ ì´ í•„ìš”í•¨", weight: 4 },
                    { text: "ëŒ€ê¸° ì‹œê°„", weight: 3 },
                    { text: "ëŠê¹€ í˜„ìƒ", weight: 2 },
                    { text: "ë¶€ì •í™•", weight: 1 }
                ],
                // ğŸ†• ì¶”ê°€ëœ 3ì¤„ ìš”ì•½ ë°ì´í„°
                summary: [
                    "ì‚¬ìš©ìë“¤ì€ ì£¼ë¡œ ë¹ ë¥¸ í™˜ì „ ì†ë„ì™€ ì €ë ´í•œ ìˆ˜ìˆ˜ë£Œì— ëŒ€í•´ ë†’ì€ ë§Œì¡±ë„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.",
                    "ë°˜ë©´, ì¼ë¶€ ì‚¬ìš©ìë“¤ì€ ì•± êµ¬ë™ ì†ë„ ì €í•˜ ë° ê°„í—ì ì¸ ë¡œê·¸ì¸ ì˜¤ë¥˜ì— ëŒ€í•´ ë¶ˆí¸ì„ í˜¸ì†Œí–ˆìŠµë‹ˆë‹¤.",
                    "ì „ë°˜ì ìœ¼ë¡œ ê¸ì •ì ì¸ í‰ê°€ê°€ ìš°ì„¸í•˜ë‚˜, ì•± ì•ˆì •ì„± ê°œì„ ì´ ì´ë£¨ì–´ì§„ë‹¤ë©´ ë” ë†’ì€ ë§Œì¡±ë„ê°€ ì˜ˆìƒë©ë‹ˆë‹¤."
                ]
            };
        }

        /* ============================
       ğŸ†• íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        ============================= */
        function downloadSummary(type, productName) {
            // ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” location.href = `/download/${type}?id=...` ë“±ì˜ ë°©ì‹ì„ ì‚¬ìš©
            const msg = type === 'pdf' ? 'ğŸ“„ PDF' : 'ğŸ“Š Excel';
            alert(`'${productName}' ìƒí’ˆì˜ ${msg} ìš”ì•½ë³¸ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.`);
        }
    </script>

    <script th:src="@{/js/product1.js}"></script>
    <script th:src="@{/js/product2.js}"></script>

</th:block>

</html>