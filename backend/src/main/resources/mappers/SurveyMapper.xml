<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.api.backend.mapper.SurveyMapper">

    <select id="selectSurveyById"
            resultType="kr.co.api.backend.dto.survey.SurveyDetailResponseDTO">
        SELECT
            s.survey_id AS surveyId,
            s.title AS title,
            s.description AS description
        FROM TB_SURVEY s
        WHERE s.survey_id = #{surveyId}
    </select>

    <select id="selectSurveyQuestions"
            resultType="kr.co.api.backend.dto.survey.SurveyQuestionResponseDTO">
        SELECT
            q.q_id AS qId,
            q.q_no AS qNo,
            q.q_key AS qKey,
            q.q_text AS qText,
            q.q_type AS qType,
            q.is_required AS isRequired,
            q.max_select AS maxSelect
        FROM TB_SURVEY_Q q
        WHERE q.survey_id = #{surveyId}
        ORDER BY q.q_no ASC
    </select>

    <select id="selectQuestionOptions"
            resultType="kr.co.api.backend.dto.survey.SurveyOptionResponseDTO">
        SELECT
            o.opt_id AS optId,
            o.opt_code AS optCode,
            o.opt_text AS optText,
            o.opt_value AS optValue,
            o.opt_order AS optOrder
        FROM TB_SURVEY_OPT o
        WHERE o.q_id = #{qId}
        ORDER BY o.opt_order ASC
    </select>

    <select id="selectResponseId" resultType="long">
        SELECT r.resp_id AS respId
        FROM TB_SURVEY_RESP_HDR r
        WHERE r.survey_id = #{surveyId}
          AND r.cust_code = #{custCode}
    </select>

    <insert id="insertResponseHeader"
            parameterType="kr.co.api.backend.dto.survey.SurveyResponseHeaderDTO"
            useGeneratedKeys="true"
            keyProperty="respId"
            keyColumn="RESP_ID">
        INSERT INTO TB_SURVEY_RESP_HDR (
            survey_id,
            cust_code,
            status
        ) VALUES (
                     #{surveyId},
                     #{custCode},
                     #{status}
                 )
    </insert>



    <update id="updateResponseHeaderStatus">
        UPDATE TB_SURVEY_RESP_HDR
        SET status = #{status, jdbcType=VARCHAR}
        WHERE resp_id = #{respId, jdbcType=NUMERIC}
    </update>

    <delete id="deleteResponseDetails">
        DELETE FROM TB_SURVEY_RESP_DTL
        WHERE resp_id = #{respId, jdbcType=NUMERIC}
    </delete>

    <insert id="insertResponseDetails">
        INSERT ALL
        <foreach collection="details" item="detail">
            INTO TB_SURVEY_RESP_DTL (
            resp_id,
            q_id,
            opt_id,
            answer_text
            ) VALUES (
            #{detail.respId, jdbcType=NUMERIC},
            #{detail.qId, jdbcType=NUMERIC},
            #{detail.optId, jdbcType=NUMERIC},
            #{detail.answerText, jdbcType=VARCHAR}
            )
        </foreach>
        SELECT 1 FROM DUAL
    </insert>



    <select id="selectOptionValues"
            resultType="kr.co.api.backend.dto.survey.SurveyOptionValueDTO">
        SELECT
        o.opt_id AS optId,
        o.q_id AS qId,
        o.opt_value AS optValue
        FROM TB_SURVEY_OPT o
        WHERE o.opt_id IN
        <foreach collection="optIds" item="optId" open="(" separator="," close=")">
            #{optId, jdbcType=NUMERIC}
        </foreach>
    </select>

    <select id="selectLatestResponseId" resultType="long">
        SELECT resp_id AS respId
        FROM TB_SURVEY_RESP_HDR
        WHERE survey_id = #{surveyId}
          AND cust_code = #{custCode}
        ORDER BY resp_id DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="selectResponseAnswers"
            resultType="kr.co.api.backend.dto.survey.SurveyResponseAnswerDTO">
        SELECT
        d.q_id AS qId,
        d.opt_id AS optId,
        o.opt_value AS optValue
        FROM TB_SURVEY_RESP_DTL d
        LEFT JOIN TB_SURVEY_OPT o
        ON d.opt_id = o.opt_id
        WHERE d.resp_id = #{respId}
        ORDER BY d.q_id ASC
    </select>

    <delete id="deleteRecommendations">
        DELETE FROM TB_CUST_RECO_TOP3
        WHERE cust_code = #{custCode}
          AND survey_id = #{surveyId}
    </delete>

    <insert id="insertRecommendations">
        INSERT ALL
        <foreach collection="recs" item="rec">
            INTO TB_CUST_RECO_TOP3 (
            cust_code,
            survey_id,
            rank_no,
            product_id
            ) VALUES (
            #{rec.custCode, jdbcType=VARCHAR},
            #{rec.surveyId, jdbcType=NUMERIC},
            #{rec.rankNo, jdbcType=NUMERIC},
            #{rec.productId, jdbcType=VARCHAR}
            )
        </foreach>
        SELECT 1 FROM DUAL
    </insert>

    <select id="selectRecommendations"
            resultType="kr.co.api.backend.dto.survey.SurveyRecommendationDTO">
        SELECT
        r.product_id AS dpstId,
        p.dpst_name AS dpstName,
        p.dpst_info AS dpstInfo,
        p.dpst_descript AS dpstDescript,
        p.dpst_currency AS dpstCurrency,
        r.rank_no AS rankNo
        FROM TB_CUST_RECO_TOP3 r
        LEFT JOIN TB_DPST_PROD_INFO p
        ON r.product_id = p.dpst_id
        WHERE r.cust_code = #{custCode}
          AND r.survey_id = #{surveyId}
        ORDER BY r.rank_no ASC
    </select>

    <select id="selectActiveProductIds" resultType="string">
        SELECT dpst_id
        FROM TB_DPST_PROD_INFO
        WHERE dpst_status = 3
        ORDER BY dpst_reg_dt DESC
    </select>

    <select id="selectProductSummaries"
            resultType="kr.co.api.backend.dto.survey.SurveyProductDTO">
        SELECT
        I.DPST_ID AS dpstId,
        I.DPST_NAME AS dpstName,
        I.DPST_INFO AS dpstInfo,
        I.DPST_DESCRIPT AS dpstDescript,
        I.DPST_CURRENCY AS dpstCurrency,
        I.DPST_TYPE AS dpstType,
        I.DPST_PERIOD_TYPE AS dpstPeriodType,
        I.DPST_PART_WDRW_YN AS dpstPartWdrwYn,
        I.DPST_ADD_PAY_YN AS dpstAddPayYn,
        I.DPST_AUTO_RENEW_YN AS dpstAutoRenewYn,
        P.PERIOD_MIN_MONTH AS periodMinMonth,
        P.PERIOD_MAX_MONTH AS periodMaxMonth,
        P.PERIOD_FIXED_MONTH AS periodFixedMonth
        FROM TB_DPST_PROD_INFO I
        LEFT JOIN TB_DPST_PROD_PERIOD P ON TRIM(I.DPST_ID) = TRIM(P.PERIOD_DPST_ID)
        WHERE I.DPST_ID IN
        <foreach collection="productIds" item="productId" open="(" separator="," close=")">
            #{productId, jdbcType=VARCHAR}
        </foreach>
    </select>

</mapper>
